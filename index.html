<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Empire City: Online Fixed</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: sans-serif; }
        canvas { display: block; }
        
        #auth { position: fixed; inset: 0; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; color: white; }
        #auth input { padding: 15px; font-size: 20px; border-radius: 8px; margin: 20px; text-align: center; border: none; outline: none; }
        #auth button { padding: 15px 50px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-size: 20px; font-weight: bold; }
        
        #chat-box { position: absolute; bottom: 160px; left: 20px; width: 250px; height: 120px; background: rgba(0,0,0,0.6); color: white; overflow-y: auto; font-size: 13px; padding: 10px; border-radius: 5px; pointer-events: none; display: none; border: 1px solid rgba(255,255,255,0.2); }
        #chat-input-container { position: absolute; bottom: 110px; left: 20px; width: 250px; display: none; z-index: 100; }
        #chat-input { width: 100%; padding: 10px; background: #222; border: 1px solid #fff; color: white; border-radius: 5px; font-size: 16px; }
        
        #ui { position: absolute; top: 20px; left: 20px; color: #55ff55; font-size: 18px; pointer-events: none; z-index: 10; }
        #joy-base { position: absolute; bottom: 30px; right: 30px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid #fff; }
        #joy-stick { position: absolute; width: 40px; height: 40px; background: #fff; border-radius: 50%; left: 30px; top: 30px; pointer-events: none; }
        #btn-chat { position: absolute; bottom: 30px; left: 20px; width: 60px; height: 60px; background: #e74c3c; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; z-index: 100; cursor: pointer; border: 2px solid #fff; }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>

<div id="auth">
    <h1 style="color:#e74c3c; letter-spacing: 2px;">CITY ONLINE</h1>
    <input type="text" id="nick" placeholder="–¢–í–û–ô –ù–ò–ö" maxlength="10">
    <button id="go">–ò–ì–†–ê–¢–¨</button>
</div>

<div id="chat-box"></div>
<div id="chat-input-container"><input type="text" id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></div>
<div id="btn-chat">üí¨</div>

<div id="ui">CASH: $12,500,000<br><span id="sp">0 MPH</span></div>
<div id="joy-base"><div id="joy-stick"></div></div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const socket = io("https://gta-servers.onrender.com"); // <-- –ù–µ –∑–∞–±—É–¥—å —Å—Å—ã–ª–∫—É!

// –ï–¥–∏–Ω—ã–π —Å–ø–∞–≤–Ω —Å –Ω–µ–±–æ–ª—å—à–∏–º —Ä–∞–∑–±—Ä–æ—Å–æ–º (—á—Ç–æ–±—ã –Ω–µ –∑–∞—Å—Ç—Ä—è—Ç—å)
let player = { 
    name: "Player", 
    x: 400 + (Math.random()*60 - 30), 
    y: 400 + (Math.random()*60 - 30), 
    angle: 0, speed: 0, color: '#ff3333' 
};

let gameActive = false, joy = { active: false, ang: 0, dist: 0 }, opponents = {};

// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ —á–µ—Ä–µ–∑ pointerdown
document.getElementById('go').addEventListener('pointerdown', () => {
    const val = document.getElementById('nick').value;
    player.name = val ? val.toUpperCase() : "RACER";
    document.getElementById('auth').style.display = 'none';
    document.getElementById('chat-box').style.display = 'block';
    gameActive = true;
});

const chatInput = document.getElementById('chat-input');
const chatContainer = document.getElementById('chat-input-container');

document.getElementById('btn-chat').addEventListener('pointerdown', (e) => {
    e.stopPropagation();
    const isHidden = chatContainer.style.display === 'none' || chatContainer.style.display === '';
    chatContainer.style.display = isHidden ? 'block' : 'none';
    if(isHidden) chatInput.focus();
});

chatInput.onkeydown = (e) => {
    if(e.key === 'Enter' && chatInput.value) {
        socket.emit('chatMessage', { name: player.name, text: chatInput.value });
        chatInput.value = '';
        chatContainer.style.display = 'none';
    }
};

socket.on('chatMessage', (msg) => {
    const div = document.createElement('div');
    div.innerHTML = `<b>${msg.name}:</b> ${msg.text}`;
    const cb = document.getElementById('chat-box');
    cb.appendChild(div);
    cb.scrollTop = cb.scrollHeight;
});

socket.on('opponents', (data) => { opponents = data; });

function drawCar(c, name) {
    ctx.save();
    ctx.translate(c.x, c.y); ctx.rotate(c.angle);
    ctx.fillStyle = '#111'; ctx.fillRect(-25, -18, 12, 6); ctx.fillRect(13, -18, 12, 6);
    ctx.fillStyle = c.color; ctx.fillRect(-35, -15, 70, 30);
    ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.fillRect(5, -12, 15, 24);
    ctx.restore();
    if(name) {
        ctx.fillStyle = "white"; ctx.font = "bold 16px Arial"; ctx.textAlign = "center";
        ctx.fillText(name, c.x, c.y - 45);
    }
}

function update() {
    if(!gameActive) { requestAnimationFrame(update); return; }
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    if(joy.active) {
        let diff = joy.ang - player.angle;
        while(diff < -Math.PI) diff += Math.PI*2;
        while(diff > Math.PI) diff -= Math.PI*2;
        player.angle += diff * 0.1;
        player.speed += 0.25 * joy.dist;
    }
    player.speed *= 0.95;
    player.x += Math.cos(player.angle) * player.speed;
    player.y += Math.sin(player.angle) * player.speed;

    socket.emit('update', { x: player.x, y: player.y, angle: player.angle, name: player.name, color: player.color });

    ctx.clearRect(0,0,canvas.width, canvas.height);
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(0.6, 0.6);
    ctx.translate(-player.x, -player.y);

    // –î–æ—Ä–æ–≥–∞ –¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞ (—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è)
    ctx.fillStyle = '#2c3e50'; ctx.fillRect(-2000, 300, 5000, 200);

    for(let id in opponents) if(id !== socket.id) drawCar(opponents[id], opponents[id].name);
    drawCar(player, player.name);

    ctx.restore();
    document.getElementById('sp').innerText = Math.round(player.speed*12) + " MPH";
    requestAnimationFrame(update);
}

const stick = document.getElementById('joy-stick'), base = document.getElementById('joy-base');
function handleMove(e) {
    if(!gameActive) return;
    const t = e.touches ? e.touches[0] : e;
    const r = base.getBoundingClientRect();
    const dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
    const d = Math.min(Math.hypot(dx, dy), 40);
    joy.ang = Math.atan2(dy, dx); joy.dist = d/40; joy.active = true;
    stick.style.transform = `translate(${Math.cos(joy.ang)*d}px, ${Math.sin(joy.ang)*d}px)`;
}
window.addEventListener('touchstart', handleMove, {passive: false});
window.addEventListener('touchmove', handleMove, {passive: false});
window.addEventListener('touchend', () => { joy.active = false; stick.style.transform = 'none'; });

update();
</script>
</body>
</html>
