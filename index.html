<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Empire City: Next-Gen</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1b4d3e; touch-action: none; font-family: 'Segoe UI', Tahoma, sans-serif; }
        canvas { display: block; }
        
        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        #auth { position: fixed; inset: 0; background: radial-gradient(circle, #2c3e50, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; color: white; }
        #auth h1 { font-size: 40px; margin-bottom: 10px; text-shadow: 0 0 20px #e74c3c; color: #e74c3c; }
        #auth input { padding: 15px; font-size: 18px; border-radius: 30px; border: 2px solid #e74c3c; background: rgba(0,0,0,0.5); color: white; text-align: center; width: 200px; outline: none; }
        #auth button { margin-top: 20px; padding: 15px 60px; background: #e74c3c; color: white; border: none; border-radius: 30px; font-size: 20px; font-weight: bold; box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4); }

        /* –ß–∞—Ç */
        #chat-ui { position: absolute; bottom: 120px; left: 20px; width: 280px; z-index: 200; pointer-events: none; }
        #chat-messages { height: 120px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 8px; margin-bottom: 5px; display: none; }
        #chat-messages div { margin-bottom: 4px; color: #fff; font-size: 13px; text-shadow: 1px 1px #000; }
        #chat-input-container { display: none; pointer-events: auto; }
        #chat-input { width: 100%; padding: 12px; border-radius: 20px; border: 2px solid #fff; background: rgba(0,0,0,0.8); color: white; font-size: 16px; outline: none; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #ui { position: absolute; top: 20px; right: 20px; color: #55ff55; font-weight: bold; font-size: 20px; text-shadow: 2px 2px #000; text-align: right; pointer-events: none; }
        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 3px solid rgba(255,255,255,0.5); backdrop-filter: blur(5px); }
        #joy-stick { position: absolute; width: 50px; height: 50px; background: #fff; border-radius: 50%; left: 30px; top: 30px; box-shadow: 0 0 20px rgba(255,255,255,0.5); }
        #btn-chat-toggle { position: absolute; bottom: 40px; right: 40px; width: 70px; height: 70px; background: #e74c3c; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; z-index: 210; border: 3px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.3); pointer-events: auto; }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>

<div id="auth">
    <h1>CITY NEXT-GEN</h1>
    <input type="text" id="nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" maxlength="12">
    <button id="go">–í –ì–û–†–û–î</button>
</div>

<div id="ui">$12,500,000<br><span id="speed" style="font-size: 14px; color: white;">0 MPH</span></div>

<div id="chat-ui">
    <div id="chat-messages"></div>
    <div id="chat-input-container">
        <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å...">
    </div>
</div>
<div id="btn-chat-toggle">üí¨</div>

<div id="joy-base"><div id="joy-stick"></div></div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const socket = io("https://gta-servers.onrender.com");

const GRID = 1000, ROAD = 350;
let player = { name: "Player", x: 500, y: 500, angle: 0, speed: 0, color: '#ff3333', particles: [] };
let opponents = {}, gameActive = false, joy = { active: false, ang: 0, dist: 0 };

// –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
document.getElementById('go').addEventListener('pointerdown', () => {
    player.name = document.getElementById('nick').value.toUpperCase() || "RACER";
    document.getElementById('auth').style.display = 'none';
    document.getElementById('chat-messages').style.display = 'block';
    gameActive = true;
});

// –ß–∞—Ç
const btnChat = document.getElementById('btn-chat-toggle');
const inputCont = document.getElementById('chat-input-container');
const chatInp = document.getElementById('chat-input');

btnChat.addEventListener('pointerdown', (e) => {
    e.stopPropagation();
    const isVisible = inputCont.style.display === 'block';
    inputCont.style.display = isVisible ? 'none' : 'block';
    if (!isVisible) chatInp.focus();
});

chatInp.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && chatInp.value.trim()) {
        socket.emit('chatMessage', { name: player.name, text: chatInp.value });
        chatInp.value = '';
        inputCont.style.display = 'none';
    }
});

socket.on('chatMessage', (m) => {
    const msgs = document.getElementById('chat-messages');
    msgs.innerHTML += `<div><b>${m.name}:</b> ${m.text}</div>`;
    msgs.scrollTop = msgs.scrollHeight;
});

socket.on('opponents', (d) => { opponents = d; });

function drawCar(c, isPlayer) {
    ctx.save();
    ctx.translate(c.x, c.y);
    ctx.rotate(c.angle);
    
    // –¢–µ–Ω—å
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.fillRect(-35, -15, 80, 40);

    // –ö—É–∑–æ–≤
    ctx.fillStyle = c.color;
    ctx.beginPath();
    ctx.roundRect(-40, -20, 80, 40, 5);
    ctx.fill();

    // –°—Ç–µ–∫–ª–æ
    ctx.fillStyle = '#111';
    ctx.fillRect(-10, -16, 25, 32);

    // –§–∞—Ä—ã
    ctx.fillStyle = '#ffffaa';
    ctx.fillRect(32, -18, 8, 6);
    ctx.fillRect(32, 12, 8, 6);

    ctx.restore();
    
    // –ù–∏–∫
    ctx.fillStyle = "white";
    ctx.font = "bold 20px Arial";
    ctx.textAlign = "center";
    ctx.shadowBlur = 4; ctx.shadowColor = "black";
    ctx.fillText(c.name, c.x, c.y - 50);
    ctx.shadowBlur = 0;
}

function drawCity() {
    const sX = Math.floor((player.x - 2000)/GRID), eX = Math.ceil((player.x + 2000)/GRID);
    const sY = Math.floor((player.y - 2000)/GRID), eY = Math.ceil((player.y + 2000)/GRID);

    for(let x=sX; x<=eX; x++) {
        for(let y=sY; y<=eY; y++) {
            const gx = x*GRID, gy = y*GRID;
            // –¢—Ä–∞–≤–∞
            ctx.fillStyle = '#1b4d3e'; ctx.fillRect(gx, gy, GRID, GRID);
            
            // –î–æ—Ä–æ–≥–∏ —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π
            ctx.fillStyle = '#333';
            ctx.fillRect(gx + GRID-ROAD, gy, ROAD, GRID);
            ctx.fillRect(gx, gy + GRID-ROAD, GRID, ROAD);
            
            // –†–∞–∑–º–µ—Ç–∫–∞
            ctx.fillStyle = '#fff';
            ctx.fillRect(gx + GRID-ROAD/2-2, gy, 4, GRID);
            ctx.fillRect(gx, gy + GRID-ROAD/2-2, GRID, 4);

            // "3D" –ó–¥–∞–Ω–∏—è
            const bx = gx + 50, by = gy + 50, bSize = GRID-ROAD-100;
            // –°—Ç–µ–Ω—ã
            ctx.fillStyle = '#1a252f'; 
            ctx.fillRect(bx, by, bSize, bSize);
            // –ö—Ä—ã—à–∞
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(bx+10, by+10, bSize-20, bSize-20);
            // KFC –õ–æ–≥–æ
            ctx.fillStyle = '#e74c3c'; ctx.font = "bold 30px Arial";
            ctx.fillText("KFC", bx+40, by+70);
        }
    }
}

function update() {
    if(!gameActive) { requestAnimationFrame(update); return; }
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    if(joy.active) {
        let diff = joy.ang - player.angle;
        while(diff < -Math.PI) diff += Math.PI*2;
        while(diff > Math.PI) diff -= Math.PI*2;
        player.angle += diff * 0.1;
        player.speed += 0.3 * joy.dist;
    }
    player.speed *= 0.95;
    player.x += Math.cos(player.angle) * player.speed;
    player.y += Math.sin(player.angle) * player.speed;

    socket.emit('update', { x: player.x, y: player.y, angle: player.angle, name: player.name, color: player.color });

    ctx.clearRect(0,0,canvas.width, canvas.height);
    
    // –≠—Ñ—Ñ–µ–∫—Ç —Ç—Ä—è—Å–∫–∏ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏
    ctx.save();
    if(player.speed > 5) {
        ctx.translate((Math.random()-0.5)*player.speed, (Math.random()-0.5)*player.speed);
    }
    
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(0.5, 0.5);
    ctx.translate(-player.x, -player.y);

    drawCity();

    for(let id in opponents) if(id !== socket.id) drawCar(opponents[id], false);
    drawCar(player, true);

    ctx.restore();

    document.getElementById('speed').innerText = Math.round(player.speed*15) + " KM/H";
    requestAnimationFrame(update);
}

// –î–∂–æ–π—Å—Ç–∏–∫ —Å–ª–µ–≤–∞
const stick = document.getElementById('joy-stick'), base = document.getElementById('joy-base');
function handleMove(e) {
    if(!gameActive) return;
    const t = e.touches ? e.touches[0] : e;
    const r = base.getBoundingClientRect();
    const dx = t.clientX - (r.left + 55), dy = t.clientY - (r.top + 55);
    const d = Math.min(Math.hypot(dx, dy), 40);
    joy.ang = Math.atan2(dy, dx); joy.dist = d/40; joy.active = true;
    stick.style.transform = `translate(${Math.cos(joy.ang)*d}px, ${Math.sin(joy.ang)*d}px)`;
}
window.addEventListener('touchstart', handleMove, {passive: false});
window.addEventListener('touchmove', handleMove, {passive: false});
window.addEventListener('touchend', () => { joy.active = false; stick.style.transform = 'none'; });

update();
</script>
</body>
</html>
